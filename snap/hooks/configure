#!/bin/sh -e

###################################################################################
# Shell script hook for running when Subsonic snap install/refresh/config change.
#
# Author: ArubIslander
###################################################################################

# Note: set some environment variables relative to the snap.

export SUBSONIC_HOME=$SNAP_USER_COMMON/var/subsonic
export SUBSONIC_DEFAULT_MUSIC_FOLDER=$SNAP_USER_COMMON/var/music
export SUBSONIC_DEFAULT_PODCAST_FOLDER=$SNAP_USER_COMMON/var/music/Podcast
export SUBSONIC_DEFAULT_PLAYLIST_FOLDER=$SNAP_USER_COMMON/var/playlists

SUBSONIC_TRANSCODE=$SUBSONIC_HOME/transcode

mkdir -p "$SUBSONIC_TRANSCODE"
# lame
if [ -L "$SUBSONIC_TRANSCODE/lame" ]; then
    rm $SUBSONIC_TRANSCODE/lame
fi
ln -s $SNAP/usr/bin/lame $SUBSONIC_TRANSCODE/lame

# ffmpeg
if [ -L "$SUBSONIC_TRANSCODE/ffmpeg" ]; then
    rm $SUBSONIC_TRANSCODE/ffmpeg
fi
ln -s $SNAP/usr/bin/ffmpeg $SUBSONIC_TRANSCODE/ffmpeg

# flac
if [ -L "$SUBSONIC_TRANSCODE/flac" ]; then
    rm $SUBSONIC_TRANSCODE/flac
fi
ln -s $SNAP/usr/bin/flac $SUBSONIC_TRANSCODE/flac

mkdir -p "$SUBSONIC_HOME"
mkdir -p "$SUBSONIC_DEFAULT_MUSIC_FOLDER"
mkdir -p "$SUBSONIC_DEFAULT_PODCAST_FOLDER"
mkdir -p "$SUBSONIC_DEFAULT_PLAYLIST_FOLDER"

SUBSONIC_PORT=${SUBSONIC_PORT:-4040}
SUBSONIC_HTTPS_PORT=${SUBSONIC_HTTPS_PORT:-0}
SUBSONIC_CONTEXT_PATH=${SUBSONIC_CONTEXT_PATH:-/}
SUBSONIC_DB=${SUBSONIC_DB}
SUBSONIC_MAX_MEMORY=${SUBSONIC_MAX_MEMORY:-150}

#export PATH=$SNAP/usr/lib/jvm/java-8-openjdk-$SNAP_ARCH/bin:$PATH

# Obtain configuration value
value=$(snapctl get host)
host="${value:-0.0.0.0}"

# Validate it
if ! expr "$host" :  '^[0-9]\+\.[0-9]\+\.[0-9]\+\.[0-9]\+$' > /dev/null; then
    echo "\"$host\" is not a valid host value" >&2
    exit 1
fi

# Obtain configuration value
value="$(snapctl get port)"
port="${value:-4040}"

# Validate it
if ! expr "$port" : '^[0-9]\+$' > /dev/null; then
    echo "\"$port\" is not a valid port" >&2
    exit 1
fi

# Obtain configuration value
value="$(snapctl get https-port)"
https_port="${value:-0}"

# Validate it
if ! expr "$https_port" : '^[0-9]\+$' > /dev/null; then
    echo "\"$https_port\" is not a valid port" >&2
    exit 1
fi

# Obtain configuration value
value="$(snapctl get context-path)"
context_path="${value:-/}"

# Validate it
if ! expr "$context_path" : '^/[^/]*$' > /dev/null; then
    echo "\"$context_path\" is not a context path" >&2
    exit 1
fi

# Obtain configuration value
value="$(snapctl get max-memory)"
max_memory="${value:-150}"

# Validate it
if ! expr "$max_memory" : '^[0-9]\+$' > /dev/null; then
    echo "\"$max_memory\" is not a max-memory value" >&2
    exit 1
fi
